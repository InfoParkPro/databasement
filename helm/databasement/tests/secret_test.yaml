suite: secret tests
chart:
  version: 0.1.0
  appVersion: 0.1.0
templates:
  - templates/secret.yaml
tests:
  - it: should not render secret when no app key or db password
    asserts:
      - hasDocuments:
          count: 0

  - it: should render secret with app key value
    set:
      app:
        appKey:
          value: "base64:testkey123456789012345678901234567890"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: data.app-key
          decodeBase64: true
          value: "base64:testkey123456789012345678901234567890"

  - it: should not render secret when app key uses fromSecret
    set:
      app:
        appKey:
          fromSecret:
            secretName: "external-secret"
            secretKey: "APP_KEY"
    asserts:
      - hasDocuments:
          count: 0

  - it: should render secret with database password value
    set:
      app:
        appKey:
          value: "base64:testkey"
      database:
        connection: mysql
        password:
          value: "dbpassword123"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: data.db-password
          decodeBase64: true
          value: "dbpassword123"

  - it: should not include db-password when using fromSecret
    set:
      app:
        appKey:
          value: "base64:testkey"
      database:
        connection: mysql
        password:
          fromSecret:
            secretName: "db-secret"
            secretKey: "password"
    asserts:
      - hasDocuments:
          count: 1
      - notExists:
          path: data.db-password

  - it: should not include db-password for sqlite connection
    set:
      app:
        appKey:
          value: "base64:testkey"
      database:
        connection: sqlite
        password:
          value: "ignored"
    asserts:
      - hasDocuments:
          count: 1
      - notExists:
          path: data.db-password
